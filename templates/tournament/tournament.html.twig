{% extends 'front.html.twig' %}

{% block title %}üèÜ Nos Tournois{% endblock %}
{% block body %}
 <section class="banner_part">
            <div class="container">
                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-8 col-md-10">
                        <div class="banner_text">
                            <div class="banner_text_iner text-center">
                                <h1>{% block banner_title %}Explore Tournaments{% endblock %}</h1>
                                <p>{% block banner_subtitle %}D√©couvrez les comp√©titions gaming{% endblock %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


<div class="container py-5">

    <!-- FILTER BAR -->
    <div class="card bg-dark border-0 shadow mb-5">
        <div class="card-body">
            <div class="row g-3 align-items-center">

                <div class="col-md-4">
                    <h4 class="text-white mb-0">
                        <i class="fas fa-trophy text-warning me-2"></i>
                        Tous les Tournois
                    </h4>
                </div>

                <div class="col-md-5">
                    <input type="text"
                           class="form-control bg-dark text-white border-secondary"
                           placeholder="Rechercher..."
                           id="searchInput">
                </div>

                <div class="col-md-3">
                    <select class="form-select bg-dark text-white border-secondary"
                            id="statusFilter">
                        <option value="">Tous les statuts</option>
                        <option value="open">Ouverts</option>
                        <option value="ongoing">En cours</option>
                        <option value="completed">Termin√©s</option>
                    </select>
                </div>

            </div>
        </div>
    </div>

    <!-- TOURNAMENTS -->
    <div class="row g-4">

        {% for tournament in tournaments %}

        <div class="col-lg-4 col-md-6 tournament-card"
             data-game="{{ tournament.game|lower }}"
             data-status="{{ tournament.status }}"
             data-name="{{ tournament.name|lower }}">

            <div class="card bg-dark text-white border-0 shadow-sm h-100 tournament-box">

                <div class="card-body d-flex flex-column">

                    <!-- Status -->
                    <div class="mb-2">
                        <span class="badge bg-{{
                            tournament.status == 'ongoing' ? 'success' :
                            (tournament.status == 'open' ? 'primary' :
                            (tournament.status == 'completed' ? 'warning' : 'secondary'))
                        }}">
                            {{ tournament.status|capitalize }}
                        </span>
                    </div>

                    <!-- Title -->
                    <h5 class="fw-bold mb-2">{{ tournament.name }}</h5>
                    <small class="text-muted mb-3">
                        <i class="fas fa-gamepad me-1"></i>{{ tournament.game }}
                    </small>

                    <!-- Progress -->
                    {% set progress = tournament.maxTeams > 0
                        ? (tournament.teams|length / tournament.maxTeams * 100)
                        : 0 %}

                    <div class="mb-3">
                        <div class="progress" style="height:6px;">
                            <div class="progress-bar bg-info"
                                 style="width: {{ progress > 100 ? 100 : progress }}%;">
                            </div>
                        </div>
                        <small class="text-muted">
                            {{ tournament.teams|length }} / {{ tournament.maxTeams }} √©quipes
                        </small>
                    </div>

                    <!-- Dates -->
                    <small class="text-muted">
                        üìÖ Inscriptions: {{ tournament.registrationDeadline|date('d M Y') }}
                    </small>
                    <small class="text-muted mb-3">
                        üéØ D√©but: {{ tournament.startDate|date('d M Y H:i') }}
                    </small>

                    <!-- Spacer -->
                    <div class="mt-auto"></div>

                    <!-- Buttons -->
                    <a href="{{ path('app_tournament_view', {'id': tournament.id}) }}"
                       class="btn btn-outline-light btn-sm w-100 mb-2">
                        Voir D√©tails
                    </a>

                    {% if is_granted('IS_AUTHENTICATED_FULLY') and tournament.status == 'open' %}
                    <button class="btn btn-success btn-sm w-100 join-btn"
                        data-tournament-id="{{ tournament.id }}"
                        data-token="{{ csrf_token('join_tournament') }}">
                        Rejoindre
                    </button>
                    {% endif %}

                </div>
            </div>
        </div>

        {% else %}
        <div class="col-12 text-center text-white py-5">
            <h4>Aucun tournoi disponible</h4>
        </div>
        {% endfor %}

    </div>
</div> </section> <div class="modal fade" id="joinModal" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-dark text-white" style="border: 1px solid #444;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Rejoindre le tournoi</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label class="form-label">Choisissez votre √©quipe :</label>
                <select id="teamSelect" class="form-control bg-dark text-white border-secondary">
                    <option>Chargement...</option>
                </select>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirmJoin">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<section class="dummy-section">
{% endblock %}

{% block stylesheets %}
<style>
.tournament-box {
    transition: all 0.3s ease;
    border-radius: 15px;
}
.tournament-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
}
/* Fix modal blocked by theme */
.modal {
    z-index: 9999 !important;
}

.modal-backdrop {
    z-index: 9998 !important;
}

/* Ensure no parent container has a transform that resets z-index */
body.modal-open .banner_part, 
body.modal-open .container {
    transform: none !important;
    perspective: none !important;
    filter: none !important;
}

/* Remove stacking context created by theme */
.banner_part,
header,
.navbar,
.section,
.container {
    transform: none !important;
}
.modal-backdrop {
    display: none !important; /* Temporary test: if you can click now, the backdrop was the problem */
}
/* Better fix: */
.modal {
    background: rgba(0, 0, 0, 0.8); /* Manual backdrop */
}
</style>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    let selectedTournament = null;

    // Use jQuery (which your template already loads) for the modal
    const $modal = $('#joinModal');

    document.querySelectorAll('.join-btn').forEach(button => {
        button.addEventListener('click', function () {
            selectedTournament = this.dataset.tournamentId;
            
            fetch('/api/user/teams')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('teamSelect');
                    select.innerHTML = '';
                    const teams = data.teams;

                    if (!teams || teams.length === 0) {
                        select.innerHTML = '<option value="">Aucune √©quipe disponible</option>';
                    } else {
                        teams.forEach(team => {
                            const option = document.createElement('option');
                            option.value = team.id;
                            option.textContent = `${team.name} (ELO ${team.elo})`;
                            select.appendChild(option);
                        });
                    }
                    // Trigger modal show via jQuery to match template version
                    $modal.modal('show');
                });
        });
    });

    /*
     * STEP 2 ‚Äî CONFIRM JOIN (ONLY ONE LISTENER)
     */
    document.getElementById('confirmJoin').addEventListener('click', function () {

        const teamId = document.getElementById('teamSelect').value;

        if (!teamId) {
            alert('Veuillez s√©lectionner une √©quipe.');
            return;
        }

        const token = document.querySelector(
            '.join-btn[data-tournament-id="' + selectedTournament + '"]'
        ).dataset.token;

        const formData = new FormData();
        formData.append('teamId', teamId);
        formData.append('tournamentId', selectedTournament);
        formData.append('_token', token);

        fetch('/tournament/join', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {

            alert(data.message);

            if (data.success) {
                location.reload();
            }
        })
        .catch(err => {
            console.error('Join error:', err);
            alert('Erreur serveur.');
        });

    });

    /*
     * FILTER SYSTEM (unchanged)
     */
    document.getElementById('searchInput').addEventListener('input', filterTournaments);
    document.getElementById('statusFilter').addEventListener('change', filterTournaments);

    function filterTournaments() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;

        document.querySelectorAll('.tournament-card').forEach(card => {
            const game = card.dataset.game;
            const status = card.dataset.status;
            const name = card.dataset.name;

            const matchesSearch = game.includes(searchTerm) || name.includes(searchTerm);
            const matchesStatus = !statusFilter || status === statusFilter;

            card.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

});
</script>
{% endblock %}
