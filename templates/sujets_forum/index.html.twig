{% extends 'back.html.twig' %}

{% block body %}

<style>
    .pieWrap { display:flex; gap:16px; align-items:center; }
    .pie {
        width:150px;
        height:150px;
        border-radius:50%;
        border:10px solid #fff;
        box-shadow: 0 1px 12px rgba(0,0,0,0.06);
        background: conic-gradient(#ddd 0deg 360deg);
    }
    .legendItem { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .legendColor { width:14px; height:14px; border-radius:3px; }
    .mutedSmall { font-size:12px; color:#6c757d; }

    .rowDot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:10px; vertical-align:middle; }
    .dotRed { background:#dc3545; }
    .dotGreen { background:#198754; }
</style>

{# ====== HEADER ====== #}
<div class="page-header mb-4">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">Forum Management</h5>
        </div>
        <ul class="breadcrumb ms-3 mb-0">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item">Sujets du forum</li>
        </ul>
    </div>

    <div class="page-header-right ms-auto d-flex gap-2">
        <a href="{{ path('app_sujets_forum_new') }}" class="btn btn-primary">
            <i class="feather-plus me-2"></i>Nouveau sujet
        </a>
        <a href="{{ path('front_index') }}" class="btn btn-light-brand">
            <i class="feather-arrow-left me-2"></i>Retour accueil
        </a>
    </div>
</div>

{# ====== FILTERS (CARD) ====== #}
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="{{ path('app_sujets_forum_index') }}">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Rechercher</label>
                    <input type="text" name="search" class="form-control"
                           placeholder="Titre, auteur, catégorie..."
                           value="{{ search|default('') }}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Catégorie</label>
                    <select name="categorie" class="form-select">
                        <option value="">Toutes</option>
                        {% for key, cat in categories %}
                            <option value="{{ cat }}" {{ (categorie_filter|default('')) == cat ? 'selected' : '' }}>
                                {{ cat }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="feather-filter me-2"></i>Filtrer
                    </button>
                </div>

                <div class="col-md-2">
                    <a href="{{ path('app_sujets_forum_index') }}" class="btn btn-light w-100">
                        Réinitialiser
                    </a>
                </div>
            </div>
        </form>

        {# TRI (chips style) #}
        <div class="mt-3 d-flex flex-wrap align-items-center gap-2">
            <span class="text-muted">Trier par :</span>
            {% set ord = order|default('desc') %}

            <a href="{{ path('app_sujets_forum_index', {
                search: search|default(''),
                categorie: categorie_filter|default(''),
                sort: 'titre',
                order: (sort|default('')) == 'titre' ? (ord == 'desc' ? 'asc' : 'desc') : 'asc'
            }) }}"
               class="btn btn-sm {{ (sort|default('')) == 'titre' ? 'btn-primary' : 'btn-light' }}">
                Titre {{ (sort|default('')) == 'titre' and ord == 'asc' ? '↑' : '↓' }}
            </a>

            <a href="{{ path('app_sujets_forum_index', {
                search: search|default(''),
                categorie: categorie_filter|default(''),
                sort: 'date_creation',
                order: (sort|default('')) == 'date_creation' ? (ord == 'desc' ? 'asc' : 'desc') : 'desc'
            }) }}"
               class="btn btn-sm {{ (sort|default('date_creation')) == 'date_creation' ? 'btn-primary' : 'btn-light' }}">
                Date {{ (sort|default('')) == 'date_creation' and ord == 'asc' ? '↑' : '↓' }}
            </a>

            <a href="{{ path('app_sujets_forum_index', {
                search: search|default(''),
                categorie: categorie_filter|default(''),
                sort: 'nb_messages',
                order: (sort|default('')) == 'nb_messages' ? (ord == 'desc' ? 'asc' : 'desc') : 'desc'
            }) }}"
               class="btn btn-sm {{ (sort|default('')) == 'nb_messages' ? 'btn-primary' : 'btn-light' }}">
                Nb messages {{ (sort|default('')) == 'nb_messages' and ord == 'asc' ? '↑' : '↓' }}
            </a>
        </div>
    </div>
</div>

{# ====== TABLE (CARD) ====== #}
<div class="card mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Titre</th>
                    <th>Créé par</th>
                    <th>Catégorie</th>
                    <th>Date</th>
                    <th>Verrouillé</th>
                    <th>Messages</th>
                    <th class="text-nowrap">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for s in sujets_forums %}
                    {% set isLocked = s.estVerrouille %}
                    {% set dotClass = isLocked ? 'dotRed' : 'dotGreen' %}

                    <tr>
                        <td>{{ s.id }}</td>
                        <td>
                            <span class="rowDot {{ dotClass }}"></span>
                            {{ s.titre }}
                        </td>
                        <td>{{ s.creePar }}</td>
                        <td>{{ s.categorie }}</td>
                        <td>{{ s.dateCreation ? s.dateCreation|date('d/m/Y H:i') : '-' }}</td>
                        <td>
                            <span class="badge {{ isLocked ? 'bg-danger' : 'bg-success' }}">
                                {{ isLocked ? 'Oui' : 'Non' }}
                            </span>
                        </td>
                        <td><strong>{{ s.messagesForum|length }}</strong></td>
                        <td class="text-nowrap">
                            <a href="{{ path('app_sujets_forum_showB', {'id': s.id}) }}" class="btn btn-sm btn-light me-1">
                                <i class="feather-eye"></i> Voir
                            </a>
                            <a href="{{ path('app_sujets_forum_edit', {'id': s.id}) }}" class="btn btn-sm btn-primary">
                                <i class="feather-edit-2"></i> Modifier
                            </a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">Aucun sujet pour le moment.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# ====== STATS (UNDER TABLE) ====== #}
{% set totalSujets = sujets_forums|length %}
{% set totalMessages = 0 %}
{% set totalLocked = 0 %}
{% for s in sujets_forums %}
    {% set totalMessages = totalMessages + (s.messagesForum|length) %}
    {% if s.estVerrouille %}
        {% set totalLocked = totalLocked + 1 %}
    {% endif %}
{% endfor %}
{% set totalUnlocked = totalSujets - totalLocked %}

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="rounded-circle border border-3 d-flex align-items-center justify-content-center"
                     style="width:64px;height:64px;font-weight:800;">
                    {{ totalSujets }}
                </div>
                <div>
                    <div class="fw-bold">Sujets</div>
                    <small class="text-muted">Total sujets</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="rounded-circle border border-3 d-flex align-items-center justify-content-center"
                     style="width:64px;height:64px;font-weight:800;">
                    {{ totalMessages }}
                </div>
                <div>
                    <div class="fw-bold">Messages</div>
                    <small class="text-muted">Total messages</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="rounded-circle border border-3 d-flex align-items-center justify-content-center"
                     style="width:64px;height:64px;font-weight:800;">
                    {{ totalLocked }}
                </div>
                <div>
                    <div class="fw-bold">Verrouillés</div>
                    <small class="text-muted">Sujets verrouillés</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="rounded-circle border border-3 d-flex align-items-center justify-content-center"
                     style="width:64px;height:64px;font-weight:800;">
                    {{ totalUnlocked }}
                </div>
                <div>
                    <div class="fw-bold">Ouverts</div>
                    <small class="text-muted">Sujets non verrouillés</small>
                </div>
            </div>
        </div>
    </div>
</div>

{# ====== PIE (CSS conic-gradient) : Messages par sujet ====== #}
<div class="row g-3">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="fw-bold">Messages par sujet (Pie)</div>
                    <small class="text-muted">{{ totalMessages }} messages</small>
                </div>

                {% set colors = ['#f5c400','#1e88e5','#43a047','#e53935','#8e24aa','#fb8c00','#00acc1','#6d4c41','#3949ab','#00897b'] %}
                {% set deg = 0 %}
                {% set gradientParts = [] %}

                {# Eviter division par 0 #}
                {% set denom = totalMessages > 0 ? totalMessages : 1 %}

                {% for s in sujets_forums %}
                    {% set count = s.messagesForum|length %}
                    {% set percentage = (count * 100 / denom)|round(2) %}
                    {% set slice = (percentage * 3.6) %}
                    {% set color = colors[loop.index0 % (colors|length)] %}

                    {% set start = deg %}
                    {% set end = deg + slice %}
                    {% set gradientParts = gradientParts|merge([color ~ ' ' ~ start ~ 'deg ' ~ end ~ 'deg']) %}
                    {% set deg = end %}
                {% endfor %}

                {% if gradientParts|length == 0 %}
                    {% set gradient = '#ddd 0deg 360deg' %}
                {% else %}
                    {% set gradient = gradientParts|join(', ') %}
                {% endif %}

                <div class="pieWrap mt-3">
                    <div class="pie" style="background: conic-gradient({{ gradient }});"></div>

                    <div style="flex:1; min-width:0;">
                        {% for s in sujets_forums %}
                            {% set count = s.messagesForum|length %}
                            {% set percentage = (count * 100 / denom)|round(2) %}
                            {% set color = colors[loop.index0 % (colors|length)] %}

                            <div class="legendItem">
                                <div class="legendColor" style="background: {{ color }}"></div>
                                <div style="min-width:0;">
                                    <div class="text-truncate" style="font-weight:600;">
                                        {{ s.titre }}
                                    </div>
                                    <div class="mutedSmall">
                                        {{ count }} messages • {{ percentage }}%
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-muted">Aucun sujet.</div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% endblock %}
