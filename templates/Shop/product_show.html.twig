<!doctype html>
<html lang="zxx">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>View & Order</title>

    <base href="/front_template/">

    <link rel="icon" href="img/favicon.png">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        .navbar-brand img { height: 44px !important; width: auto !important; object-fit: contain; }

        .body_bg{
            position: relative;
            min-height: 100vh;
            background: url("img/latest_war_img_1.png") center/cover no-repeat fixed;
        }
        .body_bg::before{
            content:"";
            position:absolute;
            inset:0;
            background: linear-gradient(135deg, rgba(0,0,0,.72), rgba(0,0,0,.40));
            pointer-events:none;
            z-index:0;
        }
        .body_bg > *{ position:relative; z-index:1; }

        .section_padding{ padding: 45px 0 80px !important; }

        .panel{
            background: rgba(255,255,255,.95);
            border: 1px solid rgba(255,255,255,.20);
            border-radius: 18px;
            box-shadow: 0 18px 55px rgba(0,0,0,.28);
            backdrop-filter: blur(8px);
            overflow: hidden;
        }
        .panel-inner{ padding: 18px; }

        .media-wrap{
            background: linear-gradient(180deg,#f6f7f9,#ffffff);
            border-radius: 16px;
            height: 360px;
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }
        .media-wrap img{
            width:100%;
            height:100%;
            object-fit: contain;
        }
        .media-placeholder{
            width:100%;
            height:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#777;
        }

        .pill{
            display:inline-flex;
            align-items:center;
            gap:8px;
            padding:7px 11px;
            border-radius:999px;
            font-weight:900;
            font-size:.78rem;
            background: rgba(13,110,253,.12);
            color:#0d6efd;
        }
        .pill.gray{
            background: rgba(108,117,125,.12);
            color:#6c757d;
        }
        .pill.ai{
            background: rgba(111,66,193,.14);
            color:#6f42c1;
        }

        .stock-badge{
            position:absolute;
            top:14px;
            right:14px;
            padding:7px 10px;
            border-radius:999px;
            font-weight:900;
            font-size:.78rem;
            display:inline-flex;
            align-items:center;
            gap:8px;
            box-shadow:0 10px 18px rgba(0,0,0,.15);
        }
        .stock-in{ background: rgba(25,135,84,.92); color:#fff; }
        .stock-low{ background: rgba(255,193,7,.95); color:#111; }
        .stock-out{ background: rgba(220,53,69,.95); color:#fff; }

        .p-title{ font-weight: 900; font-size: 1.6rem; margin: 12px 0 6px; color:#111; }
        .p-desc{ color:#6c757d; margin: 0; line-height: 1.55; }
        .price{
            font-weight: 900;
            font-size: 1.25rem;
            color:#111;
        }
        .divider{
            height:1px;
            background: rgba(0,0,0,.08);
            margin: 14px 0;
        }

        .form-label{ font-weight: 800; margin-bottom: 6px; }
        .form-control{
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,.12);
            height: 46px;
        }
        .form-control:focus{
            border-color: rgba(13,110,253,.50);
            box-shadow: 0 0 0 .2rem rgba(13,110,253,.15);
        }
        .btn_1{
            border-radius: 999px;
            font-weight: 900;
            letter-spacing: .2px;
        }

        .help-note{
            color:#6c757d;
            font-size:.92rem;
            margin-top: 12px;
        }

        .nav-pill-btn{
            display:inline-flex;
            align-items:center;
            gap:10px;
            padding:10px 14px;
            border-radius:999px;
            background: rgba(255,255,255,.12);
            color:#fff;
            font-weight:900;
            text-decoration:none;
            border:1px solid rgba(255,255,255,.18);
        }
        .nav-pill-btn:hover{ color:#fff; background: rgba(255,255,255,.18); }
    </style>
</head>

<body>
<div class="body_bg">

    <header class="main_menu single_page_menu">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light">
                <a class="navbar-brand" href="/">
                    <img src="img/levelup_logo.png" alt="LevelUp">
                </a>

                <div class="collapse navbar-collapse main-menu-item">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="{{ path('shop_products') }}">Shop</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ path('my_orders') }}">My Orders</a></li>
                    </ul>
                </div>

                <div class="d-none d-sm-flex align-items-center" style="gap:10px;">
                    <a class="nav-pill-btn" href="{{ path('shop_cart') }}">
                        <i class="fas fa-shopping-cart"></i> Cart
                    </a>
                    <a class="btn_1 d-none d-md-block" href="{{ path('shop_products') }}">Back To Shop</a>
                </div>
            </nav>
        </div>
    </header>

    <section class="section_padding">
        <div class="container">

            {% for msg in app.flashes('success') %}
                <div class="alert alert-success">{{ msg }}</div>
            {% endfor %}
            {% for msg in app.flashes('error') %}
                <div class="alert alert-danger">{{ msg }}</div>
            {% endfor %}

            <div class="panel">
                <div class="panel-inner">
                    <div class="row g-4 align-items-start">

                        <div class="col-lg-6">
                            <div class="media-wrap">
                                {% if product.stock is defined %}
                                    {% if product.stock <= 0 %}
                                        <span class="stock-badge stock-out">Out of stock</span>
                                    {% elseif product.stock <= 5 %}
                                        <span class="stock-badge stock-low">Low ({{ product.stock }})</span>
                                    {% else %}
                                        <span class="stock-badge stock-in">In stock</span>
                                    {% endif %}
                                {% endif %}

                                {% set imgSrc = null %}
                                {% if product.image %}
                                    {% if product.image starts with('http') or product.image starts with('/') %}
                                        {% set imgSrc = product.image %}
                                    {% else %}
                                        {% set imgSrc = asset('uploads/products/' ~ product.image) %}
                                    {% endif %}
                                {% endif %}

                                {% if imgSrc %}
                                    <img src="{{ imgSrc }}" alt="{{ product.name }}"
                                         onerror="this.onerror=null;this.src='{{ asset('uploads/products/placeholder.png') }}';">
                                {% else %}
                                    <div class="media-placeholder">No image</div>
                                {% endif %}
                            </div>

                            <div class="mt-3 d-flex flex-wrap gap-2">
                                <span class="pill">{{ product.category ?? 'Uncategorized' }}</span>
                                <span class="pill gray">Secure checkout</span>
                                <span class="pill gray">Fast delivery</span>
                            </div>

                            <div class="p-title">{{ product.name }}</div>

                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <div class="price">
                                    {{ (product.price ?? 0)|number_format(2, '.', '') }} TND
                                </div>

                                {% if product.stock is defined %}
                                    <div class="text-muted font-weight-bold">
                                        Stock: {{ product.stock }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="divider"></div>

                            <p class="p-desc">
                                {{ product.description ?? 'No description.' }}
                            </p>
                        </div>

                        <div class="col-lg-6">
                            <div class="panel" style="box-shadow:none;">
                                <div class="panel-inner">
                                    <h4 class="mb-3" style="font-weight:900;color:#111;">Add to cart</h4>

                                    <form method="post"
                                          action="{{ path('shop_cart_add', {id: product.id}) }}"
                                          novalidate>

                                        <div class="mb-3">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" min="1" max="20" value="1" name="qty" class="form-control">
                                        </div>

                                        {% if product.stock is defined and product.stock <= 0 %}
                                            <div class="alert alert-warning mb-3">
                                                This product is currently out of stock.
                                            </div>
                                            <button class="btn_1 w-100" type="button" disabled style="opacity:.6;">
                                                Out of Stock
                                            </button>
                                        {% else %}
                                            <button class="btn_1 w-100" type="submit">
                                                <i class="fas fa-shopping-cart mr-2"></i> Add to Cart
                                            </button>
                                        {% endif %}

                                        <p class="help-note mb-0">
                                            Then go to <b>Cart</b> to checkout and choose payment method.
                                        </p>
                                    </form>

                                    <div class="mt-3 d-grid">
                                        <a href="{{ path('shop_cart') }}" class="btn btn-outline-primary" style="border-radius:999px;font-weight:900;">
                                            <i class="fas fa-arrow-right mr-1"></i> Go to Cart
                                        </a>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>

                    {# âœ… AI Recommendations (API) #}
                    <div class="divider"></div>
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <h4 class="mb-2" style="font-weight:900;color:#111;">Recommended for you</h4>
                        <span class="pill ai">AI API</span>
                    </div>
                    <p class="text-muted mb-3" style="font-weight:600;">
                        These suggestions are generated by our ML recommendation service (FastAPI) based on purchase history.
                    </p>

                    {% if recommendations is defined and recommendations|length > 0 %}
                        <div class="row">
                            {% for rec in recommendations %}
                                {% set rp = rec.product %}
                                {% if rp %}
                                    {% set rImg = null %}
                                    {% if rp.image %}
                                        {% if rp.image starts with('http') or rp.image starts with('/') %}
                                            {% set rImg = rp.image %}
                                        {% else %}
                                            {% set rImg = asset('uploads/products/' ~ rp.image) %}
                                        {% endif %}
                                    {% endif %}

                                    <div class="col-md-6 mb-3">
                                        <a href="{{ path('shop_product_show', {id: rp.id}) }}" style="text-decoration:none;">
                                            <div class="panel" style="box-shadow:none;">
                                                <div class="panel-inner">
                                                    <div style="height:160px;border-radius:14px;background:#f6f7f9;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                                                        {% if rImg %}
                                                            <img src="{{ rImg }}" alt="{{ rp.name }}" style="width:100%;height:100%;object-fit:contain;"
                                                                 onerror="this.onerror=null;this.src='{{ asset('uploads/products/placeholder.png') }}';">
                                                        {% else %}
                                                            <div class="text-muted">No image</div>
                                                        {% endif %}
                                                    </div>

                                                    <div class="mt-2" style="font-weight:900;color:#111;">
                                                        {{ rp.name }}
                                                    </div>
                                                    <div class="text-muted small">{{ rp.category ?? 'Uncategorized' }}</div>

                                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                                        <div style="font-weight:900;color:#111;">
                                                            {{ (rp.price ?? 0)|number_format(2, '.', '') }} TND
                                                        </div>
                                                        <div class="text-muted small">
                                                            Match: {{ (rec.score * 100)|round(1) }}%
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            No AI recommendations yet. Make sure the ML API is running and refresh data:
                            <code>POST /refresh/recommendations</code>
                        </div>
                    {% endif %}

                </div>
            </div>

        </div>
    </section>

</div>

<script src="js/jquery-1.12.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
</body>
</html>